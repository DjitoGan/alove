# Docker Compose v2 (sans clé "version")
# Utilise infra/.env pour quelques variables simples (ports, DB)

services:
  db:
    image: postgres:16
    container_name: alove_db
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-alove}
      POSTGRES_USER: ${POSTGRES_USER:-alove}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-alove}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - alove_pg:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: alove_redis
    command: ["redis-server", "--appendonly", "yes"]
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - alove_redis:/data

  meilisearch:
    image: getmeili/meilisearch:v1.7
    container_name: alove_meilisearch
    restart: unless-stopped
    environment:
      MEILI_NO_ANALYTICS: "true"
      MEILI_ENV: "development"
      MEILI_MASTER_KEY: "${MEILI_MASTER_KEY:-dev-master-key}"
    ports:
      - "${MEILI_PORT:-7700}:7700"
    volumes:
      - alove_meili:/meili_data
    healthcheck:
      test: ["CMD-SHELL", "test -f /meili_data/data.ms/data.mdb || exit 0"]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 3s

  minio:
    image: minio/minio:RELEASE.2024-06-13T22-53-53Z
    container_name: alove_minio
    command: server /data --console-address ":9001"
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-alove}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-alovealove}"
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - alove_minio:/data

  api:
    build:
      context: ../apps/api
      dockerfile: Dockerfile.dev
    container_name: alove_api
    env_file:
      - .env # pour PORT/API_URL éventuels
      - ../apps/api/.env.development
    depends_on:
      db:
        condition: service_started
      redis:
        condition: service_started
      meilisearch:
        condition: service_healthy
      minio:
        condition: service_started
    ports:
      - "${API_PORT:-3001}:3001"
    volumes:
      # chemins relatifs robustes (basés sur l’emplacement de ce fichier)
      - ../apps/api:/usr/src/app:delegated
      # Exclure node_modules du host pour éviter les conflits d'architecture
      - api_node_modules:/usr/src/app/node_modules
    working_dir: /usr/src/app
    command: npm run start:dev

  web:
    build:
      context: ../apps/web
      dockerfile: Dockerfile.dev
    container_name: alove_web
    env_file:
      - .env # pour WEB_PORT éventuel
      - ../apps/web/.env.development
    depends_on:
      - api
    ports:
      - "${WEB_PORT:-3000}:3000"
    volumes:
      - ../apps/web:/usr/src/app:delegated
      # Exclure node_modules du host pour éviter les conflits d'architecture
      - web_node_modules:/usr/src/app/node_modules
    working_dir: /usr/src/app
    command: npm run dev

volumes:
  alove_pg:
  alove_redis:
  alove_meili:
  alove_minio:
  api_node_modules:
  web_node_modules:
